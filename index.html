<!DOCTYPE html>
<html>
<head>
    <title>Inventory Scanner</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div id="reader" style="width: 100%;"></div>
    <div id="form-container" style="display:none; padding: 20px;">
        <p>Scanned Barcode: <span id="scanned-result"></span></p>
        <input type="number" id="quantity" placeholder="Enter Quantity" inputmode="numeric">
        <button onclick="submitData()">Submit & Scan Next</button>
    </div>

    <script>
        const html5QrCode = new Html5Qrcode("reader");
        const scriptURL = 'https://script.google.com/macros/s/AKfycbxhtkHEAEzRdIXmj-AHQ0Ky3ICDySSPGCPC7Ch9w4taKSUJrSbgJCEIsf2P4jvGAk1U/exec';
        const formatsToSupport = [
                Html5QrcodeSupportedFormats.CODE_128,
                Html5QrcodeSupportedFormats.UPC_A,
                Html5QrcodeSupportedFormats.UPC_E,
                Html5QrcodeSupportedFormats.EAN_13,
                Html5QrcodeSupportedFormats.CODE_39
            ];
            
            const config = { 
                fps: 30, // Maximum frame rate for iPhone
                // This creates a wide, thin scanning area (Letterbox)
                qrbox: { width: 350, height: 100 }, 
                aspectRatio: 1.0, 
                showTorchButtonIfSupported: true,
                experimentalFeatures: {
                    useBarCodeDetectorIfSupported: true // Crucial: Uses iOS native hardware decoding
                }
            };

        function startScanning() {
            html5QrCode.start(
                { facingMode: "environment" }, 
                config,
                (decodedText) => {
                    // SUCCESS LOGIC HERE
                    html5QrCode.stop(); 
                    document.getElementById('reader').style.display = 'none';
                    document.getElementById('form-container').style.display = 'block';
                    document.getElementById('scanned-result').innerText = decodedText;
                },
                undefined, // Ignore errors for speed
                formatsToSupport // Explicitly limit to these formats
            );
        }

        async function submitData() {
            const barcode = document.getElementById('scanned-result').innerText;
            const quantity = document.getElementById('quantity').value;

            // Send data to Google Sheets
            await fetch(scriptURL, {
                method: 'POST',
                body: JSON.stringify({ barcode, quantity })
            });

            // Reset UI for next scan
            document.getElementById('quantity').value = '';
            document.getElementById('form-container').style.display = 'none';
            document.getElementById('reader').style.display = 'block';
            startScanning();
        }

        startScanning(); // Initial start
    </script>
</body>

</html>
